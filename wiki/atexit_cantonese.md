<!--
Meta Description: # atexit：C 語言中的程式結束時函數註冊 ## 簡介 `atexit` 是 C 語言中的一個標準庫函數，用於註冊在程式正常結束時執行的回調函數。這些函數通常用來執行清理工作，例如釋放資源或保存狀態。 ## 文檔 ### 目的 `atexit` 函數的主要目的是讓開發者能夠在程式結束時自動執行...
Meta Keywords: atexit, void, return, cleanup1, cleanup2
-->

# atexit：C 語言中的程式結束時函數註冊

## 簡介
`atexit` 是 C 語言中的一個標準庫函數，用於註冊在程式正常結束時執行的回調函數。這些函數通常用來執行清理工作，例如釋放資源或保存狀態。

## 文檔
### 目的
`atexit` 函數的主要目的是讓開發者能夠在程式結束時自動執行特定的函數。這對於資源管理和保證數據一致性非常重要。

### 使用方式
`atexit` 的函數原型如下：
```c
int atexit(void (*func)(void));
```
- `func`：這是一個指向不帶參數且返回類型為 `void` 的函數的指針。

如果成功註冊，`atexit` 會返回 0；如果註冊失敗，則返回非零值。

### 詳細說明
- `atexit` 可以註冊多個函數，這些函數會以相反的順序執行，即最後註冊的函數會最先執行。
- 註冊的函數必須在程式結束時可用，否則會導致未定義行為。
- 在程序使用 `exit()` 或 `return` 結束時，所有註冊的函數都會被調用。

## 示例
以下是 `atexit` 的基本用法示例：

```c
#include <stdio.h>
#include <stdlib.h>

void cleanup1() {
    printf("執行清理工作 1\n");
}

void cleanup2() {
    printf("執行清理工作 2\n");
}

int main() {
    if (atexit(cleanup1) != 0) {
        fprintf(stderr, "註冊 cleanup1 失敗\n");
        return 1;
    }
    if (atexit(cleanup2) != 0) {
        fprintf(stderr, "註冊 cleanup2 失敗\n");
        return 1;
    }

    printf("主程式執行中...\n");
    return 0; // 或 exit(0);
}
```

在這個範例中，當程式結束時，會依次執行 `cleanup2` 和 `cleanup1` 函數。

## 解釋
- **常見陷阱**：如果函數指針指向的函數已經被釋放或不再有效，則會導致未定義行為。確保在 `atexit` 註冊的函數不會在程式結束前被銷毀。
- **多次註冊**：可以多次註冊相同的函數，但是每次註冊都會影響執行順序，需謹慎管理。
- **信號處理**：如果程式是因為接收到特定的信號而終止的，則註冊的函數可能不會被執行。

## 總結
`atexit` 函數提供了一種簡單有效的方式來管理程式結束時的清理工作，幫助開發者確保資源的正確釋放和狀態的持久化。